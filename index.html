<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>버블버블 · Bubble Shooter</title>
<style>
  :root{
    --bg:#0e1a2b; --panel:#0b1422; --ink:#dfe7ff; --muted:#7f8aa3; --primary:#1f5eff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 800px at 50% -10%,#12223b 0%,#0a1321 50%,#070f1a 100%);
    color:var(--ink); font-family: ui-sans-serif,system-ui,AppleSDGothicNeo,'Apple Color Emoji',Segoe UI,Roboto,Pretendard,Helvetica,Arial;
    -webkit-tap-highlight-color: transparent;
    display:flex; flex-direction:column; align-items:center; gap:12px; padding:12px 10px 24px;
  }
  header{width:min(960px,100%); display:flex; align-items:center; justify-content:space-between; gap:8px}
  h1{font-size:20px; margin:0; letter-spacing:.2px}
  .pill{padding:6px 12px; border-radius:999px; background:#0f1b2e; color:var(--ink); font-size:14px; border:1px solid #1b2a44}
  .btn{cursor:pointer; user-select:none}
  .btn.primary{background:var(--primary); border:none; color:#fff}
  .wrap{
    width:min(960px,100%); aspect-ratio:9/13; max-height: calc(100dvh - 170px);
    background:linear-gradient(#111b2d,#0b1423); border:1px solid #1b2a44; border-radius:18px;
    box-shadow: 0 12px 50px rgba(0,0,0,.35) inset, 0 12px 30px rgba(0,0,0,.2);
    position:relative; overflow:hidden;
  }
  /* 반응형 캔버스 */
  canvas{width:100%; height:100%; display:block}
  /* 중앙 모달 */
  .modal{
    position:absolute; inset:auto 0 35% 0; margin:auto; width:min(420px,85%);
    background:#0f1930cc; border:1px solid #28406c; border-radius:16px; padding:18px; text-align:center;
    backdrop-filter: blur(2px);
    display:none;
  }
  .modal h2{margin:2px 0 8px; font-size:22px}
  .sub{color:var(--muted); font-size:14px; margin-bottom:10px}
  .row{display:flex; gap:8px; justify-content:center}
  .hud{
    position:absolute; top:10px; left:0; right:0; display:flex; gap:8px; justify-content:center; pointer-events:none;
  }
  .bubblePreview{
    position:absolute; left:10px; bottom:10px; width:38px; height:38px; border-radius:50%;
    box-shadow: inset 0 0 8px #ffffff33, 0 0 10px #00000055; border:1px solid #00000040;
  }
  .aimTip{
    position:absolute; left:0; right:0; bottom:54px; margin:auto; width:80px; height:10px; opacity:.25;
    background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="12"><path d="M3 9 L60 3 L117 9" stroke="white" stroke-width="3" fill="none" stroke-linecap="round"/></svg>') no-repeat center/contain;
    pointer-events:none;
  }
</style>
</head>
<body>
  <header>
    <h1>버블버블 · Bubble Shooter</h1>
    <div style="display:flex; gap:8px;">
      <div id="scorePill" class="pill">점수 0</div>
      <div id="rowsPill" class="pill">남은줄 5</div>
      <button id="restartBtn" class="pill btn primary">다시 시작</button>
    </div>
  </header>

  <div class="wrap" id="gameWrap">
    <canvas id="game"></canvas>
    <div class="hud">
      <div class="pill">화면을 탭/드래그하여 조준 후 쏘기</div>
    </div>
    <div id="nextBubble" class="bubblePreview" title="다음 공"></div>
    <div class="aimTip"></div>

    <div id="modal" class="modal">
      <h2>게임 오버 💀</h2>
      <div class="sub" id="finalText">최종 점수: 0 · 발사수: 0</div>
      <div class="row">
        <button id="again" class="pill btn primary">다시 시작</button>
      </div>
    </div>
  </div>

<script>
(() => {
/* =========================
   기본 설정
========================= */
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const wrap = document.getElementById('gameWrap');
const modal = document.getElementById('modal');
const again = document.getElementById('again');
const restartBtn = document.getElementById('restartBtn');
const scorePill = document.getElementById('scorePill');
const rowsPill = document.getElementById('rowsPill');
const nextBubbleEl = document.getElementById('nextBubble');

const COLORS = ['#ff6b6b','#ffd166','#06d6a0','#4dabf7','#b197fc','#f06595','#ffa94d','#63e6be'];
let COL_BG = '#0e1a2b';

let state;
let rafId = null;

/* 반응형 캔버스 크기 조정 */
function fitCanvas(){
  const r = wrap.getBoundingClientRect();
  // 내부 논리 해상도: 가로 360 ~ 480 사이로 보정
  const width = Math.round(Math.min(480, Math.max(360, r.width)));
  const height = Math.round(width * 13/9);
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.floor(width * dpr);
  canvas.height = Math.floor(height * dpr);
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
  if(state) state.metrics = computeMetrics(width, height, state.ballR);
}

window.addEventListener('resize', () => {
  fitCanvas();
  draw(); // 즉시 재그리기
